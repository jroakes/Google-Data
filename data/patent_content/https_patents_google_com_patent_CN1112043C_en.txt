Vocabulary
In the following description, the usage of several terms is as described below: AAL5 ATM ADAPTATION LAYER-5 (ATM Adaptation Layer-5): refer to
It is the ATM service that a class is suitable for transfer of data.ATM ASYNCHRONOUS TRANSFER MODE (asynchronous transmission
Pattern): a kind of high speed exchange and transmission technology can be used for local or wide
The territory net, perhaps the both has.It is designed to deliver data and video/audio frequency.The analog video format of a Betacam professional quality.The standard resolution of a CCIR601 Digital Television.720 * 840 (to NTSC) or 720
* 576 (to PAL) brightness, 2: 1 double samplings of colourity horizontal direction.CPU CPU: the master of process computer instruction in the Computer Architecture
Want entity.CRC CYCLE REDUNDANCY CHECK (cyclic redundancy check (CRC)):
A kind of data error detection scheme.D1 follows the digital video record form of CCIR601.Being recorded in 19 millimeters looks
Frequently on the tape.D2 follows the digital video record form of SMPTE 244M.Be recorded in 19 millimeters
On the video tape.D3 follows the digital video record form of SMTPE 244M.Be recorded in 1/2 "
On the video tape.DASD DIRECT ACCESS STORAGE DEVICE (directly visit
Access arrangement): any online data storage equipment that can be addressed or
The CD-ROM player all is a DASD.Usage and disc driver
Synonym.DMA DIRECT MEMORY ACCESS (direct memory visit): a kind of calculating
The method of mobile data in the machine architecture; Do not need CPU during its mobile data.DVI lower video compression format of relative quality is commonly used to from CD-ROM
The dish displaying video is to computer screen.E1 T1 is at the equivalent in Europe.FIFO FIRST IN FIRST OUT (first-in first-out): based on the behaviour who serves earlier first
The queue processing method of doing.GenLock refers to and the synchronized process of another vision signal.It is at computer
To what need in the catching of video, so that make digitized process and vision signal
The sweep parameter synchronization.The I/O I/O.Deng the time be used for describing time-sensitive and information that (preferably) free of discontinuities sends.
When in real time video that sends and sound signal all are etc.JPEG JOINT PHOTOGRAPHIC EXPERT GROUP (connection
Group photo phase expert group): the Working Committee that International Standards Organization subsidizes,
It has defined the global standards of a suggestion, is used for being used in computer system
The digital compression of still image.KB kilobytes: 1024 bytes.LAN LOCAL AREA NETWORK (local area network (LAN)): by twisted-pair feeder, coaxial electrical
Cable, or the high-speed transfer of fiber optic cable are with one mile or end in the small distance more
End, computer is in the same place with ancillary equipment.LRU is least recently used.MPEG MOVING PICTURE EXPERTS GROUP (mobile picture experts group):
The Working Committee that International Standards Organization subsidizes, it has defined dynamically and has looked
Frequently/digital compression/decompression standard of audio frequency.MPEG-1 is initial
Standard also in use.MPEG2 will be next standard and will support numeral
, flexibly, telescopic video transmission.It will be referred to multiple image resolving rate,
Bit rate and dispensing mechanism.MPEG1, MPEG2 is referring to MPEG.MRU MOST RECENTLY USED (using at most recently).MTNU MOST TIME TO NEXT USE (using maximum time) to next time.TSC-system formula NATIONAL TELEVISION STANDARDS
COMMITTEE (NTSC) U.S. and Japan's mark
Accurate colour television standard.Pal mode PHASE ALTERNATION LINE (phase alternation line):
The colour television standard of the European standard beyond the France.PC personal computer: can family expenses or the computer of commercial relative low price.The RAID RAID(Redundant Array of Inexpensive Disks): use that a plurality of disks or CD work in groups one
Plant storage arrangement, to improve output bandwidth and redundancy backup is provided.SCSI small computer system interface: be used for ancillary equipment and controller thereof are connected
A kind of industrial standard to computer.SIF SOURCE INPUT FORMAT (source input format): CCIR601 separates picture
1/4 of rate.SMPTE moves image and Television Engineer association.SSA Serial Storage Architecture: be used for connecting ancillary equipment and its controller to meter
A kind of standard of calculation machine.Be a kind of possible substituting to SCSI.The digital interface of T1 and telephone network, bit rate 1.544 megabit per seconds.TCP/IP TRANSMISSION?CONTROL?PROTOCOL/
INTERNET PROGRAM (transmission control protocol/internet program):
One group of agreement of U.S. Department of Defense's exploitation is to connect online dissimilar computer.VHS VERTICAL HELICAL SCAN (vertical helical scan): on tape, remember
A kind of common format of record analog video.VTR VIDEO TAPE RECORDER (video tape recorder): a kind of at tape
The equipment of last recording of video.VCR VIDEO CASSETTE RECORDER (video box mode videorecorder):
Same VTR.
A video optimized streaming server system 10 (after this being called dmedia streamer) shows in Figure 10, and it comprises that parts different on four kinds of structures are to provide scalability, high availability, and configuration flexibility.Critical piece is as follows:
1) low 12: one hardware of the switch/microcode parts that postpone, its basic task is in communication nodes 14, dispensing data and control information between one or more storage nodes 16,17 and the one or more control node 18.
2) 14: one hardware of communication nodes/microcode parts, its basic task are by known external definition interface of the people of a broadcast service such as NTSC, PAL, D1, D2
Wait and start " broadcast " (dispensing data when waiting) and " recording " (receiving data when waiting).The Digital-to-Video interface is made in the video card, and this card is included in a plurality of video ports 15 of the output of receiving each communication nodes 14.
3) storage node 16,17: hardware/microcode parts, its basic task are managed storage medium such as disk and the storage availability option that is associated.
4) 18: one hardware of control node/microcode parts, its basic task is the control command that receives and carry out the subsystem interface of an external definition of being familiar with from computer industry.
One typically has the realization of the dmedia streamer of 64 nodes may comprise 31 communication nodes, 31 storage nodes, and 2 control nodes, they all use the low switch 12 that postpones interconnected.A littler system may not comprise switch and have only a hardware node of supporting communication, storage and controlled function.The design of dmedia streamer 10 allows when user installation a mini system to be extended for a big system.Anyway dispose, the function of dmedia streamer 10 is consistent, just the number of the stream of dispensing and the multimedia hour number difference of being deposited.
The further details of low delay switch 12 has been shown in Figure 1A.A plurality of contactor chip (not shown) are by interconnected on the crossbar switch card 20, and the latter is interconnected by a surface plate (illustrating).This plane and a card 20 have constituted the low switch that postpones of of 16 node ports.Can increase additional card 20 and dispose additional node port, saying if desired disposed active redundant node port to obtain high availability.Low each port that postpones switch 12 starts such as the full-duplex channel of per second 25 Mbytes.
Information transmits by switch 12 with the form of bag.Each bag comprises a stem, and it controls the on off state of each the crossbar switch point in each switch chip.Control node 18 is that other node ( storage node 16,17 and communication nodes 14) provides the required information of peering that activates by the low switch 12 that postpones.
Figure 1B has shown the interior details of a tape storage node 17.The back can understand that storage node 17 provides a jumbo storage facility for the storage of the numeral of video image.
Here usefulness video image can comprise that one or more are suitable for the image that shows and/or handle.A video image may comprise audio-frequency unit.The one or more image may be that logic is relevant, for example the continuous frame of film or animated series.Image may be to use camera originally, the common generation of digital computer or camera and digital computer.Audio-frequency unit can with the continuous images display synchronization.The data representation of video image used herein can be any digital data format that is suitable for representing one or more image and possible sound.Numerical data can be the coding and/or the compression.
Refer again to Figure 1B, a tape storage node 17 comprises a tape library control unit interface 24, makes to visit a plurality of magnetic recordings that are included in the tape library 26.Also have an interface 28 to make and to pass through the tape library that the SCSI bus interconnect access is other.Built-in system memory 30 can be used for cushioning the video data of receiving or receiving by DMA data transmission path 32 from interface 24 or 28.System's memory block 30 may be the part of PC 34, and this PC 34 has comprised the software of tape library and document manipulation.Switch interface and buffer module 38 (also being used for disk storage node 16, communication nodes 14 and control node 18) have been finished connecting between tape storage node 17 and the low delay switch 12.In other words, module 38 is responsible for a transfer of data is divided into bag, and adds the stem of selecting the usefulness in path for switch 12 for this bag to each bag.When receiving from switch 12 when bag, module 38 is responsible for removing stem then locally buffered or otherwise handle the data of receiving.
Video data from tape library 26 enters system storage 10 in one first action of giving.Then, the initial guiding of response control node 18 is delivered to a disk storage node 16 to video data by the low switch 12 that postpones, and prepares zero access basically when needed.
The interior details of a disk storage node 16 has been shown in Fig. 1 C.Each disk storage node 16 comprises a switch interface and buffer module 40, makes data to import into or pass to the there from a RAID buffered video high-speed cache and store interface module 42.Interface 42 is delivered to a plurality of disks 45 to the video datas that receive, and with accurate RAID mode data scatter on each disk.The details of RAID storage is also described in this this book known to prior art below: " one of Redundant Array of Inexpensive Disc example (RAID) ", work such as Patterson, ACM SIGMOD meeting, Chicago, Illinois, 1-3 day in June, 1988 years, 109-116 page or leaf.
A disk storage node also has an inner PC 44, and it comprises software module 46 and 48, and they provide storage node control respectively, video file and disk control, and the RAID mapping that has the data on the disk 45.In fact, 16 to one tape storage nodes 17 of each disk storage node provide video data availability more rapidly.Each disk storage node 16 can also be in a block semiconductor memory of switch interface and buffer module 40 (in the high-speed cache mode) buffers video data so that when the request of receiving video data, use data quickly.
Generally speaking, storage node comprises the mass storage unit interface of a mass storage unit (perhaps with) and in the ability of the locally buffered data of reading or writing to it from mass storage unit.Storage node may comprise the sequential access massage storage of one or more tape drives and/or disc driver form, also may comprise random access storage device, for example one or more disc drivers of visiting, and/or semiconductor memory with random fashion.
The block diagram that in Fig. 1 D, has shown the inner member of a communication nodes 14.Similar to above-mentioned node, communication nodes 14 comprises a switch interface and buffer module 50, can resemble with it and communicate by letter with the low switch 12 that postpones foregoing.Video data directly transmission between switch interface and buffer module 50 and stream buffering and communication interface 52 is wherein delivered to stream damper by switch interface and buffer module 50, delivers to a user terminal (not shown) by communication interface 52.A PC 54 comprises software module 56 and 58, communication nodes control (as the beginning of stream/stop action) is provided respectively and activates the generation subsequently that an isochronal data flows.A frame synchronization that starts dateout to the additional input 60 of stream buffering and communication interface 52.Those data are to receive from automatic control equipment 62, and the latter is subjected to 64 controls of a system controller, 64 pairs of dmedia streamer 10 (see figure 1)s of system controller to carry out overall operation control.The input of system controller 64 response user controller top boxs 65 to produce order, makes dmedia streamer 10 can visit a requested video image.System controller 64 also has a user interface and show tools 66, it makes the user can input command, and such as by hard or soft key, and other data start the identification to video image, the scheduling of video image, and to the control of the broadcast of video image.
Each control node 18 is configured to a PC, and it comprises a switch interface module, is used for and low switch 12 interfaces that postpone.The input of each control node 18 responding system controller 64 provides information to communication nodes 14 and storage node 16,17, so that produce the connection of wanting by the low switch 12 that postpones.In addition, control node 18 also comprises software, is used for making the video data of being asked to send interface dispensing video data to user's display terminal from one or more disk storage nodes 16 taking-ups and by a flow point.Control node 18 also sends the operation that tape and disk storage node 16,17 are controlled in order by the low switch 12 that postpones.
Dmedia streamer has the external interface of three kinds of structures, as shown in Figure 1.These external interfaces are:
1) control interface a: open system interface (Ethernet, token-ring network, serial port, modulator-demodulator etc.) of carrying out ICP/IP protocol.
2) flow point send interface: be one of multiple industrial standard of the dispensing of data design (NTSC, D1, etc.).
3) automatic control interface: be used to flow the set (GenLock, BlackBurst, SMPTE clock etc.) of industrial standard control interface of the precise synchronization of output.
Issue utility commands by control interface to dmedia streamer 10.When distributing data is packed order into, control node the input data sections of being divided into (being data block), and they are dispersed on one or more storage nodes.The density of material and synchronization data user's number influences the placement of data on storage node 16,17.The user who increases density and/or synchronization means utilized more storage node on capacity and bandwidth.
When beginning by the control interface issue an order data when a terminal use is flowed, control node 18 is selected and is activated a suitable communication nodes 14 and transmitting control information is given its designation data file section position on storage node 16,17.Communication nodes 14
The storage node 16,17 that activation need relate to also continues to postpone to open and these node communications of the 12 order Bao Laiyu that send moving with the beginning data by low.
Data move between disk storage node 16 and communication nodes 14 by the low switch 12 that postpones, and use " just punctual " (just in time) dispatching algorithm.The used technology of scheduling and data flow con-trol is fully described in the back.It is multiplexed that the data of sending from a communication nodes interface flow between the disk storage node 16, and the data flow of sending from disk storage node 16 is also like this, and single like this communication nodes stream has only been used a part of capacity and the bandwidth of each disk storage node.In this way, the identical or different data that a lot of communication nodes 14 can multiplexed accessing disk storage node.For example, dmedia streamer 10 can provide terminal use's stream of 1500 independent controls from communication nodes pond 14, and wherein each all multiplexed accessing is dispersed in the same multimedia file on the disk storage node 16.This ability is called " a plurality of streams of single copy ".
Carry out with two kinds of different classifications by the order that control interface receives.Those management datas and not directly related with current control order is carried out with " low priority ".This makes an application pack new data into and not influence the dispensing of data flow to the terminal use for dmedia streamer 10.Those influence flow point and send the order of (i.e. output) to carry out with " high priority ".
The control interface order as shown in Figure 2.Be used for packing in the dmedia streamer 10 and the lower-priority data administration order of management data comprises VS-CREATE, VS-OPEN, VS-READ, VS-WRITE, VS-GET_POSITION, VS-SET_POSITION, VS-CLOSE, VS-RENAME, VS-DELETE, VS-GET_ATTRIBUTE, and VS-GET_NAMES.
The high priority order that is used to start with management flow output comprises VS-CONNECT, VS-PLAY, VS-RECORD, VS-SEEK, VS-PAUSE, VS-STOP, and VS-DISCONNECT.Control node 18 monitoring flow control commands are performed to guarantee request.This " access control " instrument in the control node 18 may refuse to start the request of stream, and this is when having surmounted the ability of dmedia streamer 10.This may take place under several situations:
1) element of some in system breaks down and has hindered and works to greatest extent;
When 2) specifying number (parameter by the VS-CREATE order is specified) when the number of visiting the stream of a data file has simultaneously surmounted one; And
3) number of the stream when from system the time has surmounted one when the number of configuration appointment is installed.
Communication nodes 14 is managed as an xenogenesis group, and wherein each all has different bandwidth (stream) capacity and physical definition.VS-CONNECT order indication dmedia streamer 10 distributes a communication nodes 14 and part or all of bandwidth thereof to carry out the dispensing of isochronal data stream.For example, dmedia streamer 10 can be play unpressed data flow with the speed of 270 megabit per seconds by some communication nodes 14, and plays packed data stream with much lower speed (1-16 megabit per second usually) simultaneously on other communication nodes 14.
Storage node 16,17th is managed as an xenogenesis group, and wherein each all has different bandwidth (stream) capacity and physical definition.The metadata (meta data) that VS-CREATE order indication dmedia streamer 10 distributes one or more storage nodes 16,17 to give a multimedia file and link.VS-CREATE command instruction current density and required synchronization user's maximum number.
The automatic control system in the broadcasting industry is supported in three additional orders: VS-CONNECT-LIST, VS-PLAY-AT-SIGNAL, and VS-RECORD-AT-SIGNAL.The VS-CONNECT-LIST order allows to be applied in one and gives play command sequence of appointment in the order of subsystem.Dmedia streamer 10 will be carried out wherein each play command, the same just as if from the control interface issue, but will leave no trace carry out the transition to the next one from the dispensing of a stream.Be the example of a sequence below:
1) control node 18 is received a VS-CONNECT-LIST order, and it plays all or part of played in order of subcommand indication file 1, file 2, file 3.Control node 18 is determined the maximum data rate of these files and Resources allocation on a communication nodes 14.Give the communication nodes of being distributed with detailed playlist, and the dispensing of stream during startup etc.
2) when the dispensing of file 1 wanes to the close, the dispensing of communication nodes 14 startup files 2 but it is not delivered to the output port of this node.When file 1 had finished or produced a signal from automatic control interface, communication nodes 14 switched to second stream to output port from first stream.This finished within a normal video frame time in 1/30 second in other words.
3) communication nodes 14 discharges the resource relevant with file 1.
VS-PLAY-AT-SIGNAL and VS-RECORD-AT-SIGNAL allow from the signal activation broadcast of the automatic control interface in outside and the transfer of data of recording operation, and its precision is in the boundary of a frame of video.In precedent, VS-CONNECT-LIST order comprises that a PLAY-AT-SIGNAL subcommand comes to start from file 1 to file according to the automatic control interface signal in outside 2 transition.If this subcommand is VS-PLAY, then has only when file 1 finishes Shi Caihui transition takes place.
Other order that dmedia streamer 10 is carried out provides the ability of managed storage level.These orders are: VS-DUMP, VS-RESTORE, VS-SEND, VS-RECEIVE, and VS-RECEIVE_AND_PLAY.Each order all causes one or more multimedia files moving between the gradation entity of storage node 16 and two external definitions.
1) VS-DUMP and VS-RESTORE make data visit between the tape storage node 17 that obtains mobile at disk storage node 16 and control node 18.Moving of data can perhaps automatically be activated by control node 18 by the control application activating.
2) VS-SEND and VS-RECEIVE provide a method of transmitting multimedia file to another dmedia streamer.As option, receiving method, medium stream distributor mechanism can be play input file to a pre-assigned communication nodes immediately and needn't wait for whole file.
Modular design in being defined in the dmedia streamer architecture and the function collection, also transmission is optimized data stream at isochronal data, so that reduce expense significantly.Play input file to a pre-assigned communication nodes immediately and needn't wait for whole file.
Modular design in being defined in the dmedia streamer architecture and the function collection, also transmission is optimized data stream at isochronal data, so that reduce expense significantly.Particularly:
1) the low bandwidth that postpones switch has surpassed the bandwidth of the node that is connected; Communication between node does not almost hinder;
2) avoided data to move into processor memory, higher bandwidth is provided;
3) avoided processing to data; Removed expensive processing unit; And
4) the mobile quilt of data is carefully dispatched, thereby has saved big data high-speed buffer memory.
With the saying of traditional computer, dmedia streamer 10 is as an interconnected adapter system, and it possesses by the low switch 12 that postpones finishes the ability that the data between the peer move.Low postpone switch 12 accesses data memory and data segment is moved on to the memory of another adapter from the memory of an adapter, and intervention that need not " host ".B. the layer management of dispensing during the waiting of digital compression video data
Dmedia streamer 10 provides the storage component of stratification, and its design allows to expand to a very big system from a very little video system.It also provides the flexibility of storage administration to satisfy video on demand to adapt to different needs, nearly video on demand, and commercial programme inserts, and the storage of high-quality uncompressed video is caught and playback.B 1. tape storages
In dmedia streamer 10, video image moves on the disk from the high-performance digital magnetic tape, and broadcasts with the much lower data transfer rate that the terminal use needs.In this way, have only very a spot of video time to exist in the disk subsystem.If " near video on demand " (Near Video on Demand), all have only so at any one time such as 5 minutes needs of each film in disk storage.A typical film of 2 hours is only needed 22 sections of 5 minutes.The result is that the required reserves of taking inventory of video image have reduced, because be not at any one time whole video images is not kept in the disk file.Have only that part of slice, thin piece that is broadcasting to appear in the disk.
In other words, if a video image needs time T just all to finish, and the storage be a numeral that comprises N data block, each data block has the part of the T/N that is about as much as video image so.Last piece of N blocks of data may deposit the not enough T/N time.
Along with increase to the number of the growth of requirement of system and stream, on the statistics on average be about video flowing request 25% at same film.But in different submicroseconds in the time interval, and spectators' distribution will make to have in those submicrosecond requests and surpass 50% and drop on a group of 15 film sections.
One aspect of the present invention is to use the most appropriate technology to satisfy this requirement.Random access box packing machine is a digital magnetic tape system (producing as IBM Corporation), and its each tape has very high power capacity, each drawer machinery 100 box tapes of automatically packing into, maximum two tape drives of each drawer.The result forms an effective film-on-demand system tape library.Yet the present invention has also realized utmost point digital magnetic tape thesaurus system at a low price so that the mass memory of film to be provided, and has realized that also low demand film directly is played to the suitable buffering area of speed then to video decompression and distribution passage from tape.
Another benefit that the level tape storage is combined with any video system is that it provides there being the quick backup of any film when disk takes place not work on the disk.An exemplary systems will keep " free time " disk, like this can be reloading from tape from film when a dish cell failure.General this will combine with the system of a RAID and class RAID.B 2. disk storage systems
When the demand to video flowing reaches a higher level, whole film existence dish is just become more effective, this has save video data has constantly been moved on to the performance cost that disk needs from tape.An exemplary systems will comprise that exists the movie library on the tape, because generally exist film number in the storehouse than big tens of times to hundreds of times of the number that is broadcasting any time.When the user asks a certain movie, it each section civilian dress go into disk storage node 16 and from the there.
When a large number of users required to see same film, keeping film was favourable on disk.These films generally are " hot topic " films this week, and before the rush hour of seeing a film in advance from the tape disk of packing into.This is in order to reduce the work load of system in rush hour.B 3. is from the film of high-speed cache
Along with the growth of requirement to " hot topic " film, dmedia streamer 10 moves into high-speed cache to crucial film by a MRU algorithm decision.This needs sizable high-speed cache, but with the ratio of the quantity of expense and active stream, the high power capacity of high-speed cache support can reduce the overall expenses of dmedia streamer 10.
Because the person's character of video data and system always know in advance which slice, thin piece is being play with next step and need what data, this fact how long, so taked certain methods to optimize to pack into the use of machine, bus performance or the like of high-speed cache, internal buffer, magnetic disc store, tape.
The algorithm that control is distributed in the placement of the content on all storage mediums and distribution makes isochronal data to divide and gives a bandwidth demand very widely.Because the dispensing of isochronal data is 100% predictable basically, thus this algorithm and traditional those be used for computer industry other department, greatly different to the always not predictable algorithm of high-speed cache of the data of user capture.C. dmedia streamer data flow (data flow) structure
As noted above, dmedia streamer 10 dispensing videos flow to multiple output, for example pass through such as LAN television set and set-top box that the network of ATM etc. connects.For satisfying demand, preferably use the distributed frame that comprises a plurality of storages and communication nodes to the number of memory capacity and stream simultaneously.Data exist on the storage node 16,17, and by communication nodes 14 dispensings.A communication nodes 14 obtains data from suitable storage node 16,17.Control node 18 provides single system image to the external world.These nodes are connected by the low switch 12 that postpones of interconnection.
Data transfer rate and the data that will send all are predictable to each stream.The present invention has utilized this predictability and has constructed a data flow structure, and it has made full use of resource and guaranteed and all can obtain when needed in the data of any each stream of stage.
Data flow between storage node 16,17 and the communication nodes 14 can be set up with several different modes.
The communication nodes 14 general a plurality of streams of dispensing of being responsible for.May occur each the request of data in these stream, the data of being asked may be from different storage node 16,17.Give same communication nodes if different storage nodes attempts to send out data simultaneously, will have only a storage node can send data so, and other storage node will get clogged.Obstruction can cause these storage nodes to attempt retransmission data, and has reduced the utilization of switch and caused the huge difference that sends data to the communication nodes required time from storage node.In the present invention, between different storage node 16,17, there is not competition to an input port of a communication nodes 14.
Required number of buffers can be definite like this: request of communication nodes 14 definite transmissions is to the required average times of storage node 16,17 and reception data.This time is sending a request to time of storage node with receive the time of replying and handle this request required time with storage node the Calais is definite mutually.And storage node is by the delay that brings from disk read data required average time and this request of processing is determined average time that this request of processing is required in the Calais mutually.Here it is handles the delay of asking.The quantity of required buffering is to cover the required memory of this delay with the data transfer rate that flows.The solution that describes below has been utilized the special circumstances of dmedia streamer environment to reduce delay and has therefore been reduced required resource.The minimizing that postpones is by using just punctual dispatching algorithm (for example in storage node and communication nodes) in each stage of data, and in conjunction with the prediction from the request of the data of previous stage realized.
The competition of the input port of 16,17 pairs of communication nodes 14 of storage node is eliminated by following 2:
1) 16,17 of a storage node just sends data to a communication nodes 14 when receiving a specific request.
2) communication nodes 14 be will all only can occurring a request from communication nodes 14 reception data so at any one time from the request serial arrangement of storage node sense data, and this does not rely on the number of the stream that communication nodes 14 sending.
Point out as top, reduce to postpone to depend on and use just punctual dispatching algorithm in each stage.Its basic principle is in each mobile stage of the data of a stream, and data have been ready to when the request to it arrives.This reduces the request of transmission and carries out the required delay of any transfer of data.Like this, when control node 18 when storage node 16 sends a request to the data of a specific stream, storage node 16 this request that almost can make an immediate response.This characteristic is very important for the method for above-mentioned solution race problem.
Because the visit to data in the dmedia streamer environment is serial, and the data transfer rate of a stream is predictable, when needs so storage node 16 can be known the request of next data to a specific stream in advance.Response request and the sign of the data of supplying are also known.Storage node 16 is also known the request to other stream where data exist and expected.Time of reading the request of coiling of this information and desired processing has been arranged, and read operation of storage node 16 scheduling makes data just be ready to before the request from communication nodes 14 arrives.For example, if the flow data rate is 250 kilobytes/second, storage node 16 is comprising each the 4th section an of video, and the request to the data of this data flow arrived once per 4 seconds so.If handle the time of a read request is 500 milliseconds (must be confident of allowing read request finish within 500 milliseconds), and Qing Qiu time is set at before from predetermined time of reception of the request of communication nodes 14 500 milliseconds at least so.The function of C 1. control nodes 18
The function of control node 18 is for the interface of control flows is provided between the dmedia streamer 10 and the external world.It is returned the external world and has showed single system's image, even if dmedia streamer 10 is realized with a distributed system itself.The function of control node is to be realized by the application programming interfaces (API) of a definition.API provides in dmedia streamer 10 function that produces video content and such as the real-time function of playing video data.Control node 18 sends the real-time request of playing or stop video to communication nodes 14.C 2. communication nodes 14
A communication nodes 14 has following thread (thread) (in same process) to be devoted to handle a real-time video interface: a thread process connection/disconnection request, thread process plays/stops and suspending/continue request, the request (search forward or backward) of jumping of a thread process.It has the data that an input thread is responsible for reading a stream from storage node 16 in addition, and an output thread is responsible for writing data to output port.
Fig. 3 illustrates a data flow structure in the communication nodes 14, is used for deal with data when playing a video.This data flow architecture comprises that an output thread 100 comes to receive data from a storage node 16.Input thread 100 is receiving data serializing from storage node, so that all have only a storage node sending data at any time.Input thread 100 guarantees that this buffer has been full of data when an output thread 102 need be write a stream from a buffer.Also has a scheduling function 104 in addition, the input-output operation of its scheduling convection current.This function is transfused to thread 100 and 102 the two use of output thread.
Each thread is all handled a request queue.The request queue 106 of output thread 102 comprises identification stream and points to the request of the associated buffer that needs empty.These requests were arranged according to the time that they need be written into video output interface.When output thread 102 had emptied a buffer, it was labeled as sky to it and calls scheduling function 104 and give input thread (so that buffer is filled up) request queue of the convection current in an input rank 108.The formation 108 of input thread 100 also is that the order of time that need be filled according to buffer is arranged.
Input thread 100 is also handled and is pressed the request queue 108 that request time is arranged.Its task is to fill up buffer from a storage node 16.To each request in its formation, output thread 100 all will carry out following operation.Input thread 100 determines to have that storage node 16 (data of a video flowing preferably itemize are distributed on several storage nodes) of the following one piece of data of this stream.Import thread 100 then and send request and ask the data that flow, wait the pending data arrival then to determined storage node (using message) by switch 12.
This agreement guarantees to have only a storage node 16 to send data to a particular communication node 14 at any one time, the conflict that brings if it has eliminated that storage node is sent out data to a communication nodes 14 asynchronously.When the data of being asked when storage node 16 arrives, input thread 100 buffer flag for full and call scheduling function 104 and cushion a request (based on the data transfer rate that flows) that empties this buffer to output thread 102.C 3. storage nodes 16
Fig. 4 illustrates the structure of storage node 16, so that data flow (data flow) is supported the broadcast to a stream (stream).Storage node 16 has a Buffer Pool that comprises video data.It has an input thread 100 and an output thread 112 to each logical disk drive, and the latter writes data to communication nodes 14 by switch matrix 12.It also has a scheduling function 114 to be used by input and output thread 110 and 112, comes scheduling operation.It also has a message threads 116, and it handles the requests for data from communication nodes 14.
When a communication nodes 14 is received the message of a request msg, message threads finds the data of being asked that have been cushioned usually, and the output thread is delivered in request (formation 118) queuing.Request is arranged in chronological order.Output thread 112 will empty this buffer and it will be added in the free-buffer table.Each input thread 110 has their request queue.For each on relevant disk drive, have the active stream of video data all keep one by request time tactic (based on data rate, the degree of data itemize) formation 102 to fill next buffer.Thread is got first request in the formation 120, it and a free-buffer are linked, and issue I/O request is filled this buffer with the data that disc driver comes.When buffer filled up, it was added in the table of full buffer.This table is checked by message threads 116 when the request of receiving stream data just.When the message of receiving data from a communication nodes 14 and required buffer when discontented, this is considered to once miss the deadline date.C 4. punctual scheduling (JUST-IN-TIME SCHEDULING) just
In communication nodes 14 and storage node 16, all use a kind of just punctual dispatching technique.This technology is used following parameters:
Bc=is in the buffer sizes of communication nodes 14;
Bs=is in the buffer sizes of storage node 16;
R=video stream data rate;
N=comprises the number of the data video bar of video flowing;
Sr=bar data transfer rate; And
sr＝r/n。
Used algorithm is as follows: (1) sfc=is at the frequency=r/bc of communication nodes to the request of a stream; And (2) dfc=is at the frequency=sr/bs that reads the request of coiling of storage node
" itemize " of video data will describe in detail at the H chapter of back.
The frequency of determining with an above-mentioned expression formula is dispatched and is asked for instructions, and makes them finish before the needs data.This realizes by " fill up " data pipe with data when beginning to play a video flowing.
Calculating to sfc and dfc is carried out when being connected, and is playing the communication nodes 14 that flows and is all carrying out in the storage node 16 that comprises video data.Frequency (or its inverse, cycle) is used to dispatch from the input (see figure 4) of the disk of storage node 16 and to the output of the port the communication nodes 14 input of storage node (and from) (see figure 3).The example of just punctual dispatching algorithm
Play a stream from being distributed in four video bars on the storage node with the speed of 2.0 megabit per seconds (250,000 byte per second).Suppose that again the buffer sizes in communication nodes is 50,000 bytes, and be 250,000 bytes at the buffer of disk node.Also tentation data is come itemize by the section with 250,000 byte per seconds.
The value of each parameter is as follows in the just punctual algorithm:
Bc=250000 byte (in the buffer sizes of communication nodes 14)
Bs=250000 byte (in the buffer sizes of storage node 16)
R=250000 byte per second (flow data rate)
N=4 (number of the video institute itemize of stream)
Sr=r/n=62500 byte per second or 250000/4 second, promptly per 4 seconds 250000
Byte;
Sfc=r/bc=1/ second (in the request frequency of communication nodes 14)
Dfc=r/bs=1/ second (in the request frequency of storage node 16).
Communication nodes 14 that be responsible for to play stream with 1/ second frequency in other words with 1 second periodic scheduling input and output request.Suppose that communication nodes 14 has two buffer allocation to flow to this, communication nodes 14 guarantees before the beginning outputting video streams these two buffers to be filled up.
Communication nodes 14 will all send message to all four storage nodes 16 that comprise a bar of video data when connecting.Preceding two storage nodes will expect to from this first section request and the scheduling disk requests fill up buffer.Communication nodes 14 will be dispatched input request (see figure 3) and be read in preceding two section to two buffers, and each has 250000 bytes.During to a playing request arrival, communication nodes 14 will confirm at first that two buffers are full, notify all storage nodes 16 to play then and be about to begin.Begin to play stream subsequently.When first buffer has been exported (with 1 second consuming time of the speed of 2 megabit per seconds or 250000 byte per seconds), communication nodes 14 is to storage node 16 request msgs.Then communication nodes with 1 second at interval successively to each storage node request msg, that is, it will be with 4 seconds interval from a particular memory node request msg.It always asks the data of 250,000 bytes at every turn.A communication nodes when being to connect, is being calculated by communication nodes 14 in the calculating of the frequency of storage node 16 request msgs.
The request of storage node 16 data of prediction convection current as following.The storage node 16 (seeing below the H chapter) that comprises the 3rd bar can expect after beginning to broadcast 1 second that later per 4 seconds once to the request of the section of next 250000 bytes.The storage node 16 that comprises the 4th bar can be expected a request after beginning to broadcast 2 seconds, later per 4 seconds once.The storage node 16 that comprises the 2nd can be expected a request after beginning to broadcast 4 seconds, later per 4 seconds once.In other words, each storage node 16 is dispatched input (as mentioned above) from disk from certain zero hour with the frequency of per 4 seconds 250000 bytes.Scheduling is to receive after the play command and after a buffer of stream is output to carry out in storage node 16.Calculating to request frequency is to carry out when receiving connection request.
It also is possible using the buffer of different sizes in communication nodes 14 with storage node 16.For example the buffer sizes in communication nodes 14 is 50000 bytes, and is 250000 bytes in the buffer sizes of storage node 16.In this case, the request frequency of communication nodes 14 will for (250000/50000) 5/ second in other words every 0.2 second, and still be 1/ second in the frequency of storage node 16.Communication nodes 14 is from two buffers of storage node read head (100000 byte) of comprising article one (annotate: section size is that 250000 bytes comprise first section storage node 16 will dispatch input from disk when connecting).When playing beginning, communication nodes 14 notice storage node 16 these part things are also defeated by first buffer.When this buffer becomes empty, the next input of communication nodes 14 scheduling.Buffer with per 0.2 second sky once, communication nodes 14 is just with the input of this frequency request from storage node 16, and with same frequency scheduling output.
In this example, communication nodes 16 can estimate that 5 requests arrive (except reading first section of 100000 bytes with 0.2 second interval, three requests will come once in broadcast beginning back in per 4 seconds when beginning like this, i.e. five of next sequence requests (each 50000 byte) will arrive later on 4 seconds of last request in the last sequence).Because the buffer sizes at storage node is 250000 bytes, so storage node 16 was once dispatched from disk input (identical with last example just) per 4 seconds.The details of 5. 1 playback action of C
Following step is followed the tracks of the control and the data flow of the playback action of a stream.Fig. 5 shows the step of the broadcast that a video is set.These steps are arranged with time sequencing.1. the user calls an order and for a particular video frequency of packing in advance a port is set.Control node 18 is delivered in this request.2. a thread of control node 18 receives this request and VS-CONNECT function.3. control node thread is opened a directory entry for this video, and for this video a descriptor memory symbol is set with the information of itemize file.4. control node 18 distributes a communication nodes 14 and an output port on this node for this request.5. control 18 message of node then and give the communication nodes 14 of being distributed.6. communication nodes 14 thread is received this message from control node 18.7. the communication nodes thread sends one to the storage node 16 that comprises the itemize file and opens request.8, a thread of each storage node 16 that the request of 9. opening is issued receives this request and opens the itemize file of being asked and distribute resource requirement, also dispatches the input (if this itemize file comprises several leading section) from disk.10. the storage node thread is beamed back one to communication nodes 14 and is replied the handle (identifier) of this itemize file in addition.11. the thread waits in the communication nodes 14 is replied from all storage nodes that relate to, just is to comprise this flow distribution resource output port is set when receiving the replying of success.12. communication nodes 14 scheduling inputs are to fill up the video data pipeline then.13. communication nodes 14 is beamed back one and is replied to control node 18 then.14. control node thread returns the handle of a stream and gives the user after receiving replying of a success from communication nodes 14, be used for the subsequent request relevant with this example of this stream.After a video flowing successfully was provided with, the step of the action of being taked when receiving a playing request is arranged as follows with time sequencing, and is presented among Fig. 6: 1. the user issued play command.2. a thread of control node 18 receives this request.3. the thread of control node 18 confirms that this request is at a stream of having set up, sends out a playing request then and gives the communication nodes 14 of being distributed.4. a thread in the communication nodes 14 receives playing request.5. communication nodes 14 sends playing request to all storage nodes that relates to 16, and they can predict that the back dispatches their operation to the request of this stream like this.The storage node of one " relating to " is exactly at least one the node that has the video image be concerned about.6. each related storage node 16 thread receives this request and works out the timetable of the request of this stream being served in the future.Each storage node that relates to 16 is beamed back one to communication nodes 14 and is replied.7. the communication nodes thread guarantees that streamline is ready (video data of having packed in advance) and the output that starts stream.8. communication nodes 14 is beamed back one and is replied to control node 18 then.9. control node 18 is beamed back one to the user and is replied and tell stream to broadcast.The input and output thread continue the dispensing video image to the port of appointment up to receiving that a stop/pause order or broadcast finish.D. the user of dmedia streamer and application interface dmedia streamer are passiveness servers, when carry out the Video service operation when an external control system is received control command.Fig. 7 has shown a system configuration of the application of dmedia streamer 10, and has shown the interface that occurs in the system.Dmedia streamer 10 provides the two-stage interface to control its operation for user and application program: a user interface ((A) among Fig. 7); And
Application programming interfaces ((B) among Fig. 7).
This two-stage interface is provided in client's control system, and it is communicated by letter with dmedia streamer 10 by a remote procedure call (RPC) mechanism.By interface being provided rather than in dmedia streamer 10, providing, thereby obtained separating of application software and dmedia streamer in client's control system.This has made things convenient for the upgrading or the replacement of dmedia streamer 10, because this does not need to change or replaces application software on client's control system.D 1. telex networks
Dmedia streamer 10 provides two kinds of user interfaces:
A command line interface; With
A graphical user interface.D 1.1 command line interfaces
Command line interface is in a user console or a prompting of interface display (65,66 among Fig. 1).Squeeze into an order in the command cue subsequent user, the front is that parameter is followed in the command keyword back.After the command execution, interface is display reminding and wait for Next Command input once more.The dmedia streamer command line interface is particularly suitable for following two kinds of operations:
Batch processing control: batch processing control is exactly to start to carry out an order line script that comprises a series of video control commands.For example in broadcasting industry, can prepare what a command script in advance, comprise the program of predicting the time of reserving of recording and in a long period, play.In the zero hour of reserving, carry out this command script with an errorlevel, and go on the air, and no longer need operator's intervention.
Automatically control: control is exactly to carry out a command sequence that is produced by program to upgrade/play the material that exists in the dmedia streamer 10 automatically.May all give the dmedia streamer 10 new material of packing into every day such as a tame news agency.The utility control program of these new materials of management can produce dmedia streamer order (for example pack into, delete, unload) and upgrade dmedia streamer 10 with these new materials.The order that is produced can be delivered to command line interface and puts into practice through pipeline.D 1.2 graphical user interface
Fig. 8 is the example of the graphical user interface of a dmedia streamer.The control panel of this interface imitation video recorder has such as Play (broadcast) Pause (time-out), Rewind (rewinding), the control control button of Stop (stopping).In addition, when an operation relates to (for example packing into needs the user to select a video image to pack into) when being selected by the user, it also provides Selection Floater.Graphical user interface is intervened particularly useful to the end user.
Also comprise " Batch " (batch processing) button 130 and " Import/Export " (outlet/import) knob 132 in the graphical user interface.Its function is described below.D 2: user function
Dmedia streamer 10 provides three types user function:
Outlet/inlet;
The broadcast control of similar video recorder; And
Advanced level user's control.D 2.1 outlet/inlets (Import/Export)
The outlet/inlet function is used for mobile video data turnover dmedia streamer 10.When a video when client's control system moves into dmedia streamer 10 (import), the source of video data is designated as an equipment or file of client's control system.Specify with a unique name in the dmedia streamer 10 destination of video data.When a video (outlet) when dmedia streamer 10 is moved out to client's control system, the source of video data is specified by its name in dmedia streamer 10, and the destination of video data is specified by file in client's control system or equipment.
In the user function of outlet/inlet class, dmedia streamer 10 also provides " deletion " function also to remove a video, and " obtaining attribute " function obtains about the information of the video of being deposited (for example name, data transfer rate).
In order to call the outlet/inlet function by graphical user interface, user's pressing " outlet/inlet " soft key 132 (Fig. 8).This brings a new panel (not shown), wherein comprises " Import " (import), " Export " (outlet), and " Delete " (deletion), " Get Allribute " (obtaining attribute) button calls function separately.The control of D 2.2 similar video recorders
Dmedia streamer 10 provides the broadcast control of a category like video recorder.Dmedia streamer graphical user interface among Fig. 8 shows that following function possesses: Load (packing into), Ejecte (ejection), Play (broadcast), Slow (at a slow speed), Pause (time-out), Stop (stopping), Rewind (rewinding), Fast Forward (F.F.) and Mute (noise elimination).These functions start by corresponding soft key on the pressing graphical user interface.The dmedia streamer command line interface provides function: Setup (foundation) like the category-be that an appointed output terminal mouth is set up a video.Be equivalent to video tape is packed in the video recorder.The broadcast of Play (broadcast)-video that has been established of startup, the broadcast that perhaps recovers the video be suspended.Pause (time-out)-time-out is play a video.Detach (disconnection)-be equivalent to video tape is ejected from video recorder.The state of Status (state)-display port, for example which video broadcasts, the time of having play, or the like.The control of D 2.3 advanced level users
In order to support special customer requirements, for example broadcasting industry the present invention also provides several advanced level users to control: Play list (possible table)-be based upon a plurality of videos of a port broadcast and broadcast order.The time of a video is broadcasted in Play length (broadcast length)-restriction.There is the sequence of operations in the command file in Batch Operation (batch operation)-finish.
Broadcasting list and broadcasting length control is to realize by " packing into " soft key 134 in graphical user interface.Each " foundation " order will specify a video image to join in the broadcast list of a particular port.It goes back the time that the designated image will broadcast.Fig. 9 shown pressed the panels that " packing into " soft key 134 backs occur on graphical user interface, selects video image to be added to broadcast in the list and specifies it to broadcast the time limit with it.When the user pressed filename in " file " frame 136, its name just entered in " filename " frame 138.When the user pressed " adding " button 140, the filename in " filename " frame 138 just was added in " possible table " frame 142 with its time limit, and showed current possible table (and time limit of each video image in the possible table).
Batch operation is by using a (see figure 8) that " batch processing " soft key 130 is realized in the graphical user interface.
When " batch processing " when soft key is activated, show that just a batch processing Selection Floater selects or input command file name (see figure 10) for the user.Press " execution " button on the batch processing Selection Floater and just begin to carry out order in the selected command file.Figure 10 is an example of " batch processing " and " execution " operation in the graphical user interface.For example the user has at first created a command script in the file under the C:/batchcmd catalogue " batch 2 "." batch processing " soft key 130 of pressing in the graphical user interface shown in Figure 8 of user is opened the batch processing Selection Floater then.Next step, the user presses " C:/batchcmd " in " catalogue " frame 146 in the batch processing Selection Floater.The result has just shown a row file in " file " frame 148." batch 2 " of pressing in " file " frame 148 OK, put it in " filename " frame 150.End user presses " execution " button 144, and just order is carried out each the bar order that exists in the file " batch 2 ".D 3. application programming interfaces
Dmedia streamer 10 provides application programming interfaces above-mentioned (API), so that utility control program and dmedia streamer 10 interactive interfacings and control its operation (can refer again to Fig. 7).
API comprises the process based on remote procedure call (RPC).Utility control program starts api function by the invocation of procedure.The parameter of the invocation of procedure is specified the function that will carry out.When calling api function, utility control program do not consider the logic and the physical location of dmedia streamer 10.The sign that the dmedia streamer 10 of Video service is provided is when client's control system starts or determines can be chosen in the utility control program initialization time.In case established the sign of dmedia streamer 10, the invocation of procedure just is directed to correct dmedia streamer 10 to obtain service.
Except situation about pointing out below, api function is a Synchronous Processing, and promptly in case a function call turns back to caller, function just finishes and no longer needs other processing at dmedia streamer 10.By api function is configured to simultaneous operation, avoided the context switching, the additional processing expenditure that asynchronous signal is handled and fed back.Because the hard real time requirement, this performance is important for video server application.
The processing of api function is to carry out by the order of the request of receiving.This has guaranteed that user's operation is with correct order execution.Must connect (foundation) earlier such as a video image could broadcast then.The order that and for example changes one " broadcast " request and subsequently one " time-out " request will bring diverse result to the user.
A VS-PLAY function startup video broadcasts and returns immediately control and gives caller (needn't wait for that the video broadcast finishes).Since the reason of this structure is to play the time generally long (a few minutes were by several hours) of a video image; and be difficult to expect (have suspend or cease and desist order); make the VS-PLAY function asynchronous; just can discharge resource, not so these resources will be uncertain occupied in long-time.
Video broadcast finish after, dmedia streamer 10 produces async call to an a system/port address by the utility control program appointment, with this video of notice utility control program incident that finishes.System/port address is determined when utility control program calls the VS-CONNECT function and connects video.Should be understood that readjustment system/port address appointment on the independent vide level of VS-PLAY.This means the finish freedom at any control point of information guiding of utility control program handlebar video.For example application may be wanted with the video that a center system/port the is handled a plurality of or whole client's control system message that finishes.In Another Application, the video that can specify a plurality of different system/port addresss the to handle client's control system message that finishes.
Rely on this API structure, make dmedia streamer 10 can support concurrent client's control system of multiple different hardware and software platform, and handle synchronous and asynchronous operation effectively, guarantee the correct order of operation requests simultaneously.For example, dmedia streamer 10 can use the IBMOS/2 operating system of moving in the PS/2 system, and client of face can use the IBM AIX operating system (IBM that moves in the RS/6000 system, OS/2, PS/2, AIX, RS6000 are the trade marks of International Business Machines Corporation).The communication of D 4. clients/dmedia streamer
Communication between client's control system and the dmedia streamer 10 is to realize by remote procedure call (RPC) mechanism such as a kind of known type.Figure 11 has shown the RPC structure of the communication between client's control system 11 and the dmedia streamer 10.When calling the dmedia streamer function, client's control system 11 be as RPC client and dmedia streamer as the RPC server.This is pointed out by (A) among Figure 11.But for an asynchronous operation, i.e. VS-PLAY, finishing of it causes dmedia streamer 10 to produce a calling to give client's control system 11.In this case, guest room control system 11 is as the RPC server, and dmedia streamer 10 is RPC clients.This is pointed out by (B) among Figure 11.D 4.1 client's control system 11
In client's control system 11, the user command line interface is made up of three inner concurrent processes (thread).First process translation user's order line is imported and is carried out desired operation by calling api function, and the result causes the RPC to dmedia streamer 10 to call ((A) among Figure 11).This process is also followed the tracks of the state of the video of setting up and playing at a plurality of output ports.Second process periodically checked the time that broadcast consumed of each video, and contrasts with separately time limit.If a video is to the time limit,, and start next video (if any) in the waiting list of same output port just this video is stopped and disconnects.The 3rd process in client's control system 11 is to receive asynchronous end notification ((B) among Figure 11) from the VS-PLAY of dmedia streamer 10 as a RPC server.B 4.2 dmedia streamers 10
In the start-up course of dmedia streamer 10, two parallel processes (thread) are called so that support RPC between client's control system 11 and the dmedia streamer 10.The RPC server ((A) among Figure 11) that first process is called as the api function from client's control system 11.First process receive RPC call and assign suitable process carry out the function of being asked (VS-CONNECT for example, VS-PLAY, VS-DISCONNECT).Second process is to call out suitable client's control system address to notify this application controls system asynchronous End Event as a RPC client.This process self block is to wait for an internal pipeline, and this pipeline is write by other process of being responsible for the video broadcast.When the latter arrived a video terminal point or runs into the abnormal end condition, it write a message to pipeline.The process of blocking is read this message and is carried out a RPC and call ((B) among Figure 11) to suitable client's control system port address, and client's control system just can be upgraded its state and take corresponding action like this.E. dmedia streamer memory organization and at the optimization of video dispensing
One aspect of the present invention provides integrated mechanism and sends environment with relevant I/O operation with adaptive video with the management of cutting high-speed cache.Describe this one side of the present invention now in detail.The cache management of E 1. prior arts
The cache management mechanism of prior art is embedded in the file subsystem of director cache and operating system.They are designed to general, rather than the needs of sending at video specially.
Figure 12 has illustrated that a kind of possible approach disposes traditional cache management mechanism and is used for the video dispensing.This technology is utilized video division (because just excessive to a file) between two disk files 160,162, the processor of include file system 166, a media server 168 and a video driver 170.This figure has illustrated that also two video adapter ports 172,174 are used for two video flowings.A data flow also has been described, a section of disk file 160 has been read in main memory, and subsequently data are write first video port 172, and another data flow, read in same section and it is write second video port 174.Figure 12 is used for illustrating the problem that prior art brings, and is proposed and solve by dmedia streamer 10 of the present invention.
Figure 12 has described steps A 1-A12A 1. media servers 168 and has called file system 166 and read a section Sk and enter video
In the buffer of driver 170.The part that A 2. file system 166 are read Sk enters a high speed of file system 166
In the buffer memory.A 3. file system 166 copy to high-speed cache a buffering of video driver 170
In the device.
Steps A 2 and A3 repeat for many times.A 4. file system 166 are called video driver 170 Sk are write video port 1 (176).A 5. video drivers 170 copy to the part of Sk one of video driver 170
In the buffer.A 6. video drivers 170 write video port 1 (176) to buffer.
Steps A 5 and A6 repeat for many times.
Steps A 7 is worked in a similar manner to A12, and just port one becomes port 2.If the part of Sk is just in time in the high-speed cache of file system 166 when port 2 needs, just can skips steps A8.
Can recognize that the video dispensing relates to lot of data by a plurality of data flow transmission.Its overall use pattern does not meet any in the pattern (at random with order) of two kinds of traditional optimization buffer memorys.If selection random fashion, most of high-speed caches may comprise the video-frequency band data of being read recently, do not read them but before they use up, do not have the video flowing queuing.If the selecting sequence mode, the high-speed cache of using is recently at first reused, so find the possibility of the section that needs just littler from the high-speed cache of file system.Said as the front that dispensing when a key factor of video dispensing is a data flow etc. can not make spectators or user feel offending pause and interruption in other words.The cache mechanism of prior art as what just pointed out, is distributed to a user in the time of can not guaranteeing video flowing etc.
The accessory problem of Figure 12 explanation is: a. disk is to carry out with relative little section with video port I/O, to satisfy the requirement of generic-document system.This needs the more multiprocessing time with respect to the section of the such size of video-frequency band, and disk is searched expense and bus expense.B. between file system cache and media server buffer, and the required processing time of copy data between media server buffer and the video driver buffer, be a kind of burden that preferably can eliminate.C. a plurality of copies that use two video buffers (promptly 172,174) to comprise same video-frequency band at synchronization are the wastes to main memory.Also existed in the file system cache in the video driver buffer when same data have both existed, just caused bigger waste.E 2. video optimized cache managements
According to this cache management operation on the one hand of the present invention three basic sides are arranged: the high-speed cache of shared segment size between each stream; Speed buffering predictably; Synchronization is to optimize the high-speed cache of shared segment size between speed buffering E 2.1 each streams
Video is to store and manage with the section of fixed size.Each section serial number makes such as that the 6th section of that part of ratio of the 5th a section video image of being deposited deposited is that part of more near the beginning of this video image.The size of section is suitably selected to optimize magnetic disc i/o, video i/o, the use of bus and the use of processor.One section of a video has convention, only by video name and segment number decision.All are to the I/O of disk and video output, and the operation of all high-speed caches, all align by segment boundary and carry out.
Of the present invention this has two kinds of forms on the one hand, depend on lower floor's hardware whether be supported between the video output card in disk and the communication nodes 14 directly to the peering (peer-to-peer operation) of data flow, and do not need by the high-speed cache transmission in the communication nodes.For peering, speed buffering carries out in disk storage unit 16.For the hardware of not supporting peering, data are the continuous high-speed cache (communication nodes 14 in) that the form advance alignment is directly read by unit with the piece of section size, move (the F chapter of face as follows: video optimized digital storage distribution) to reduce I/O operation and data as far as possible.
Data remain on same position, and directly write out from this position, till this video-frequency band no longer is required.During this video-frequency band was cushioned, all need be exported the video flowing of this video-frequency band and all visit same high-speed cache.Like this, the same copy of video-frequency band can use for many users, thereby has avoided reading the required extra use to I/O, processor and buffer memory of other copy of same video-frequency band.For peering, the most processor of a half-sum of remaining I/O operation and the use of main memory are all avoided in communication nodes 14.
Figure 13 has illustrated one embodiment of the present of invention under the situation of the system that is provided with peering.Video data has carried out itemize on the disk storage node, make the section be numbered odd number on the first disk storage node 180, and the section that is numbered even number is on second disk storage node 182 (the H chapter of face as follows).
The data flow of this configuration is also shown in Figure 13.As can be seen, section Sk writes video- out port 1 and 2 then from disk 182 is read speed buffering 184 communication nodes 186.The Sk video-data fragment is directly read in the high-speed cache 184 with an I/O operation, is written to port one then.Next step Sk video-data fragment is write inbound port 2 with an I/O operation from high-speed buffer 184.
Can understand that all problems of the described conventional method of Figure 12 has all been solved by the system that Figure 13 illustrates.
Figure 14 has illustrated the data flow that comprises a kind of configuration that is supported in the peering between disk storage node and the video output card.A pair of disc driver 190 and 192 comprises the video image of an itemize, and the latter is directly supplied with a pair of video port 194,196, and need not transmit by the main memory of an intermediate communication node 14.
The data flow of this configuration is that section Sk is directly read port one (with an I/O operation) by disk speed buffering 198 from disk 192.
Next the section of reading Sk is to port 2 if one is called, and section Sk directly reads in port 2 (with an I/O operation) from disk speed buffering 198.
When the data that are used for port one of reading in disk cache 198 when port 2 is write still there, a kind of best utilization to memory bus, processor resource is passed to port one and 2 to video-frequency band exactly.
Might combine peering and main memory speed buffering mechanism, for example a video image that broadcasts to a port of communication nodes 14 is used peering, the video image that broadcasts for a plurality of ports to communication nodes 14 then cushions in communication nodes 14.
Suitably select a kind of strategy of dividing the buffering responsibility of disk storage node and communication nodes, so that can under given hardware configuration, support the video flowing of maximum quantity.If the quantity of the stream of supporting is known, just can determine the quantity and the placement of high-speed cache.E 2.2 foresight speed bufferings (Predictive Caching)
A kind of foresight cache mechanism has catered to the cache policy that very is fit to the video dispensing.Video image generally be have foreseeable.Generally they begin to play from the outset, play one period predetermined long period with a fixed rate, just stop when having only the end of arrival.The cache method of dmedia streamer 10 has utilized this predictable set of optimizing the video-frequency band that is cushioned at any one time.
This predictable read operation of filling up a high-speed cache that is used to dispatch also is used for driving the algorithm of regaining high-speed cache.Those contents estimated that before then the buffer that can not need is regained immediately, and Free up Memory is in order to the use of higher priority.Those contents are not retracted at the buffer that needs within reasonable time, though apart from last time with it for a long time.
More specifically, given video V
1, V
2... and stream S
1, S
2, playing these videos, each stream Sj plays a video V (Sj), and the time of k the section writing V (Sj) of expectation is linear function:
T (sj, k)=a (Sj)+r (Sj) k wherein a (Sj) depend on time started and beginning segment number, r (Sj) is the set time of playing a section usefulness, (Sj k) is the moment of the k section of the broadcast stream Sj that sets to t.
This information is used to dispatch the read operation of filling a high-speed cache, also is used for driving the algorithm of recycling high-speed cache.The certain operations example of the management algorithm of high-speed cache is as follows: routine A
High-speed cache comprises the video-frequency band that an expectation can not used by any one video flowing that is broadcasting, and this part at first is repeated to utilize before being buffered in the buffer memory that any expectation of recycling will be played.After satisfying this constraint, the broadcast frequency of video and segment number are used as weighs the tolerance that this video-frequency band remains on the priority in the high-speed cache.The highest maintenance priority is given the video-frequency band that occurs earlier in this group in a frequent video that broadcasts.Example B
Concerning a high-speed cache that includes the video-frequency band that expectation will play, next estimates that the quantity of time of broadcasting and the remaining stream that will play this video-frequency band is used as the tolerance of determining to keep the priority of this video-frequency band in buffer memory.These tolerance in fact maintenance priority of a high-speed cache are set to regain the desired number (to any video-frequency band) of the I/O that high-speed cache carries out, poor with the desired number that it is remained the I/O that is carried out.
For example, if
V5 just plays on S7,
V8 is just at S
2And S
3Last broadcast, wherein S
2At S
3Next 5 seconds,
V4 is just at S
12To S
20Last broadcast, wherein each 30 seconds in next back.
So:
Comprise and at first regained with the buffer of the data of the V5 that crosses by S7,
Then be to comprise by S
2With the buffer of the data of the V8 that crosses,
Then be to comprise by S
12With the buffer of the data of the V4 that crosses,
It then is remaining buffer with minimum maintenance priority.
The cache management algorithm is also handled for some special circumstances provide flexible, for example attended operation (may predict that a video-frequency band will broadcast in the near future, but not know precise time) and shut-down operation (at that time must the previous prediction of modification).E 2.3 makes stream synchronously to optimize speed buffering
Is the stream aggregation of the same given video-frequency band of request more satisfactory together, reduced that piece high-speed cache that comprises that section like this and be kept at the time of memory, gives other video flowing thereby vacate more power system capacity.Broadcast for video, on the speed of each section broadcast, do not have what flexibility usually.But the speed of playing in the application of some videos dispensing is (video and audio frequency can quicken slightly or slow down and be unlikely to cause people's dislike) in other words flexibly.The dispensing of video may be for except allowing people's other purpose watching immediately in addition.When allowing speed that certain variation is arranged, Shu Chu stream (along time orientation) broadcasts with the speed of minimum permission in front, and the stream (along time orientation) of output broadcasts with the speed of the highest permission in the back, so that dwindle the spacing between the stream and reduce each section and must stay time in the buffer.
During connection and play operation, also considered a stream aggregation that uses same video image.For example, VS-PLAY-AT-SIGNAL can be used for beginning to broadcast a video at synchronization on a plurality of streams.This has improved gathering, has vacateed more system resource and has flowed to other, has increased the available capacity of system.More specifically, by postponing an a bit of time of stream so that consistent with second stream, aggregation method make in the high-speed cache section a copy can be used for two streams, thereby saved the processing resource.F. video optimized digital storage distributes
The difference of the attribute of digital of digital video data and those general data deal with data is that the former is nonrandom, is order, and is a large amount of, and is time critical (timecritical) but not content critical (content critical).A plurality of streams of data must need reduce to minimum to all unnecessary spending with very high bit rate dispensing on data path.Need carefully manage efficient and capacity that buffer improves dmedia streamer 10 as far as possible.The distribution of memory is reclaimed and visit is the key factor of this process, and use can cause memory fragmentation irrelevantly, and efficient reduces, and the delay of video data or destruction.
Dmedia streamer 10 of the present invention uses a Memory Allocation process, and its permission higher layer applications is the digital of digital video data distribution and reclaims non-tradable, page alignment, continuous memory section (piece).This process provides a simple high-level interface to video delivery application, and utilizes low-level operation system module and code segment with needed big or small allocate memory piece.Memory block is continuous, and is fixed in the physical storage, has eliminated the delay or the destruction of being brought by virtual memory exchange or paging, and must transmit the complexity that realizes gathering/dispersion routine in the software in data.
High-level interface also is that the memory block of being asked has returned multiple addressing mode value, thus eliminated the dynamic address translation that takes a lot of trouble with adapt to can be in the dmedia streamer environment needs of the different memory model of concurrent operations.Physical address and for the used process of multiple application linear and process sectional address can supply other device driver directly visit, hard disk drive for example.Also provide one to reclaim routine, it returns a memory block and gives system, has eliminated fragment problems, because memory all is to return with an independent piece.The used order 1. of F 1. Memory Allocation distributes physical storage:
Distribute the memory block of the size of asking, return a controll block, also have the length of piece with different memory modules address of memory area.2. recovery physical storage:
Returning memory block gives operating system and discharges relevant memory pointer.F 2. application programming interfaces
In CONFIG.SYS, defined a device driver and when system start-up auto-initiation it.Application is opened one as the device driver of pseudo-device and obtain its label then, uses this interface to come transferring command and parameter then.The order that is supported is Allocate Memory (allocate memory) and Deallocate memory (reclaiming memory), and its parameter is the pointer of memory size and logical storage address.In case the memory block of physics is assigned with and its physical address translations becomes logical address, these addresses have just been set by device driver.If distribution is failed then is returned sky.
Figure 15 has shown typical case's set of the application that will use this process.The data of 32 application request buffers 1, data are modified and put buffer 2 then into.This buffer just can be used by one 16 and use the sector address direct manipulation then, is perhaps handled by a physical equipment such as hard disk drive.Preassignment is fixing by coming with this allocative decision, buffer physics, continuous, makes each application visit data with own direct addressin method own, has eliminated the delay of address translation and dynamic memory allocation.Video Applications can be in this way, reduces data the buffer as far as possible and move by digital of digital video data directly is put into from physical disks, then it directly is sent to output equipment, and needn't repeatedly moves data in this process.G. the disc driver of optimizing at Video Applications
It is important being distributed to the destination when video flowing is waited, and promptly not having to be paused by the motion that human eye is discovered and can be interrupted this class by the sound that people's ear is discovered postpones.Existing disk technology has periodically action, for example carries out causing the remarkable predictive failure analysis that postpones in the data access.Although most I/O operate in 100 milliseconds and finish, 100 milliseconds cyclic delay is usual, also whole 3 seconds delay may take place.
Dmedia streamer 10 also must be kept high data transmission rate effectively.If the hard disk drive for conventional data storage and retrieval configuration is not used at Video service and is optimized, just the poor efficiency of internal memory use, disk buffering, SCSI bus and disk size can occur.
According to an aspect of the present invention, the disc driver of usefulness is adjusted by optimizing disk parameter here, smoothly to send lot of data again in time.These parameters can be set when the production of the hard disk drive of specialize Video service, or the variable that can be provided with by the mechanism of ordering.
The parameter of control cycle sexual act is set to reduce as far as possible or eliminate and postpones.The parameter that influences the use of buffer is set to allow transmit a large number of data in a read or write.The parameter that influences the speeds match of SCSI bus and processor bus be adjusted make transfer of data beginning both not too early, also not too late.Magnetic disk media self formats with the sector-size that capacity and bandwidth reach peak efficiency.In order to reach optimization:
The physical disks medium formats with the greatest physical sector-size that allows.This formatting options makes the space on the interval that is wasted between the sector reach minimum, makes the place capacity maximum, makes burst of data rate maximum.A preferable realization is the sector of 744 bytes.
Disk has the buffer that links.When bus can be used for transmitting data, this buffer was used for asynchronously from the magnetic disk media read data.Similarly, this buffer also is used for keeping asynchronously the data that arrive from bus when transmitting data to magnetic disk media.Buffer can be divided into several sections, and this quantity is by a parameter control.If hop count is too much, each section is just too little and can not preserve and once transmit needed data volume.When buffer full, equipment must reconnect and begin then to transmit, if next bus/Not ready at this moment is the time-delay of circulation.In preferable enforcement, this value is set to and makes all big or small the same with transfer of data at least of any buffer segments, for example is set to one.
When once reading, along with a buffer segments begins to fill, disk is attempted to reconnect carrying out once with bus the data of main frame is transmitted.Disk attempt to reconnect that influence the efficient that bus is utilized constantly.The relative velocity of bus and disk has determined that beginning is to the best time of main frame transmission during padding.Similarly, when write operation, along with arriving from the data of main frame, buffer will fill up, and this filling process certain a bit, disk should be attempted to reconnect with bus.Accurate speeds match causes the still less disconnection/reselect the cycle on the SCSI bus, and obtains higher maximum throughput.
The parameter when control is attempted to reconnect is called " the full ratio of read buffer " and " write buffer empty ratio ".For video data, the preferred algorithm of calculating these ratios is 256 * (instantaneous scsi data transfer rate-lasting data in magnetic disk transfer rate)/instantaneous scsi data transfer rate.The preferred values of the ratio of current buffer full and buffer-empty is 204.
The design of some disc drivers need periodically be done correction again to head position along with variation of temperature.It is simultaneously all magnetic heads in the assembly to be carried out thermal compensation that some such disc driver also allows to control, and still once a magnetic head is carried out thermal compensation.If once all magnetic heads are all carried out, the delay of hundreds of millisecond will take place to the read operation of video data the time subsequently.Longer read time postpone to cause need be bigger the main memory buffer come smoothed data stream and prevent artifact in the multimedia presentation.Preferred methods is that magnetic head thermal compensation control function is programmed to allow once a magnetic head to be carried out thermal compensation.
Preserving error logging and carrying out predictive failure analysis to spend finish several seconds.If do not have very large main memory buffer with smooth delay and the artifact that prevents in the multimedia presentation, these postpone for video server application is flagrant.Restriction free time function (Limit Idle Time Function) parameter can be used for forbidding preserving error logging and carrying out the free time function.Preferable enforcement is to establish a parameter to limit these functions.H. the data itemize of video data
In Video Applications, have from the needs of a plurality of streams of same data (for example film) dispensing.This requirement is converted into the needs with the High Data Rate read data; In other words, required data transfer rate of stream of dispensing multiply by the number of the stream of visiting these same data simultaneously.Traditionally, this problem is to solve by a plurality of copies of preserving data, causes the expense of adding like this.Dmedia streamer 10 of the present invention has used a copy service a lot of simultaneously the streams of a kind of technology from data.This technology has been considered the data transfer rate of an independent stream and the number of the stream of possibility while visit data.
Above-mentioned data itemize has related to the notion of logical file, and its data are existed by subregion and are called as in a plurality of file parts of bar.Each bar allows to be present on the different disk volumes, therefore allows logical file across a plurality of physical disks.Disk can be this locality or long-range.
When data were written into logical file, it was split into a plurality of logic length (i.e. section), and they are sequentially put into each bar.As shown in figure 16, the logical file of a video-video 1-is segmented into M section or piece, and each all has specific size, and 256 kilobytes for example, last section may be that part is filled up data.A data segment is put into article one, and and then next section is put into second, or the like.When each bar had all write a section, next section just write article one.Like this, if a file is assigned in N the bar, bar 1 will the section of comprising 1 so, N+1, and 2*N+1, or the like, bar 2 will the section of comprising 2, N+2, and 2*N+2, or the like, the rest may be inferred.
The known data processing that is used to the RAID scheme of a kind of similar data itemize, the purpose of its itemize are the integralities that guarantees data under the situation of a disk loss.Such RAID storage system is taken out N the odd and even data that need use when coming data recovery storage in the dish.The disk storage node 16 of dmedia streamer 10 is organized as a class RAID structure, but does not need odd and even data (because the copy of video data can obtain from tape storage).
Figure 17 has illustrated first importance of this data placement, promptly each video image is split into data block or section, and they are dispersed on the available disc driver, makes each video image to be visited simultaneously by a plurality of drivers and does not need a plurality of copies.Like this, its thought is a kind of itemize, and this is not the reason for data integrity and performance these self, but for the reason of concurrent or bandwidth.Like this, dmedia streamer 10 comes itemize to video image with the section of playing, rather than with block of bytes, or the like.
As shown in figure 17, one of them video data file 1 is divided into the M section, and splits in four bars, and bar 1 is a file that comprises section 1,5,9 grades of video file 1; Bar 2 is files that comprise section 2,6,10 grades of video file 1; Bar 3 is files that comprise section 3,7,11 grades of video file 1; Bar 4 is files that comprise section 4,8,12 grades of video file 1, till all M sections of video file 1 are included in one of four bar files.
Described itemize strategy has been arranged, and parameter is calculated according to following method, to adapt to the itemize of each independent video.
At first, Duan size is suitably selected so that obtain the reasonable effective data rate of disk.But it can not be greatly to delay is had harmful effect.It must be enough little, can be in internal memory buffer memory/high-speed cache.A section size is 256 kilobytes preferably, and it remains unchanged at the video image of 128 kilobytes/second in the 512 kilobytes/second scopes for data transfer rate.If video data rate is higher, then handy bigger section.The size of section depends on the base unit of the I/O operation in the video image scope that exists on the same medium.Used principle is to use and comprises the size of about 0.5 to 2 second video data as section.
Next step determines the number of bar, the i.e. number of the disk that video data distributed.This number must be enough greatly, keeping required conceptual data rate, and be to calculate respectively at each video image according to the utilization rate of an expectation.More specifically, each disk has a logical volume to link with it.Each video image is split into constituent element file (componentfile), and the number of constituent element is identical with the number of required bar, and each constituent element file exists on the different logical volume.For example, if video data must be sent with every stream 250 kilobytes/second, and support the stream of 30 whiles from same video, they begin with the interval such as 15 seconds, obtain the data transfer rate of at least 7.5 megabyte/seconds generally.If a disc driver can be supported the speed of average out to 3 megabyte/seconds, so this video image is needed 3 bars at least.
The effective speed that data are read from disk is subjected to the influence of the size of read operation.For example, if data are read (random site from the disk) with the piece of 4 kilobytes from disk, effective data rate just may be 1 megabyte/second.And if data are read with the piece of 256 kilobytes, then effective data rate may be 3 megabyte/seconds.If but data read with very large, the memory that buffering needs also increases, and, use the delay of institute's read data also to increase, because operation must be finished before data can be accessed.Have when selecting transfer of data big or small thus one compromise.Size is based on that the configuration of the characteristic of equipment and memory selects.The size that is preferably transfer of data is exactly selected section a size.For a given section size, just determined from the effective data rate of an equipment.For example to some disc drivers, section size is that 256 kilobytes are effective use (effective data rate is 3 megabyte/seconds) of disc driver and cushion big or small (256 kilobytes) good balance is provided.
If without itemize, the maximum number of the stream that can support just is subject to the effective data rate of disk, if for example effective data rate is 3 megabyte/seconds, the data transfer rate of a stream is 200 kilobytes/second, and the stream that can supply of disk is no more than 15 so.If such as need 60 streams of same video, data must copy on 4 dishes so.If but used according to itemize of the present invention, can use 1/4 capacity of 4 dishes.For the stream of 60 whiles of single video data copy, each bar in four can be play 15 streams simultaneously.The time started of each stream staggers, to guarantee the request evenly distribution between each to 60 streams.Be also noted that if the time started of each stream is more approaching, can reduce needs by using by the video data of high-speed cache to I/O.
For a given video, its number is subjected to two factor affecting, and first is the maximum number of the stream that provides from video at any one time, and another is at any one time from being stored in the sum of the stream that all videos on the same disk need provide with this video.
To a video, the number of bar is determined as follows:
The s=maximum (r*n/d, r*m/d), wherein:
The nominal data rate that this stream of r=will be play;
N=is with the maximum number of the stream of nominal data rate from this video image the time;
D=(notes the effective data rate section of being subjected to from disk from the effective data rate of a disk
The influence of size);
M=is with all disks of any part of self-contained this video image of nominal data rate
The maximum number of stream simultaneously; And
The number of the stream of a video image of s=.
Several disks that the data of a video image are distributed by itemize are as an aggregate, and can be thought of as be a very large physical disks.Itemize can allow a video file to surpass the size restriction of the maximum file that physical file system allowed of a system.The general data that always need on all dishes of this set, not deposit equal number of video data.For the use of balance disk, when a video during by itemize, itemize is from that maximum dish of free space.
As an example, consider the situation of a video image need playing with the speed of 2 megabit per seconds (250000 byte per second), promptly r equals 250,000 byte per seconds, and hypothesis is necessary from this video dispensing nearly stream of 30 whiles, i.e. n=30.Suppose that m also equals 30 in this example, promptly the sum of the stream of sending from all disks also is 30.Also tentation data is with the section itemize of 250000 bytes, and is 3000000 byte per seconds to given section size (250000 byte) from the effective data rate of a dish.The number n of so required itemize is 250000*30/3,000,000, promptly 2.5, and going into is 3 (s=capping (r*n/d)).
If come self-contained these data all disks stream maximum number such as be 45, so 250,000*45/3,000,000 promptly needs 3.75 bars, going into is 4 bars.
Even video is divided into 3 bars to be enough to reach from the requirement of 30 streams of a copy dispensing of this video, also comprise other content if comprise the dish of this video, and the sum of the stream that will support from that video is 45, so just needs 4 disc drivers (the itemize degree is 4).
The mode that this algorithm is used in dmedia streamer 10 is as follows.Memory (several disc drivers) is divided into disk groups.The ability (based on the effective data rate of one predetermined section size) of the stream when each group has certain capacity and dispensing given number with each disk.The section size of each group is a constant.Different groups can be selected different section sizes (and thereby have different effective data rates).When a video image will be by itemize, at first according to group of following Standard Selection.
Duan Daxiao is consistent with video data rate, if promptly the flow data rate is 250000 byte per seconds, section size just at 125K between the 500KB.Next standard is the maximum number that the quantity of disk in the assurance group is enough supported stream simultaneously, is the flow data rate as " r " promptly, and " n " is the maximum number of stream simultaneously, the number of disk when " d " is the effective data rate of a dish in the group.The sum of the stream when at last, should be sure of that videos all from disk groups need be supported is no more than its capacity.In other words, if " m " is the capacity of this group, " m-n " should more than or equal to all stream that can play simultaneously from the video that is stored in the group and.
This calculating in control node 18 in the video data 10 pairs of calculating of dmedia streamer of packing into.Under simple scenario, all disks all will be in single pond, and it has defined the total capacity of dmedia streamer 10 for the quantity of memory and supported stream.The number of the necessary disk of the stream when supporting given number in the case (or bar) is to calculate from formula m*r/d to get, and wherein m is the number of stream, and r is the data transfer rate of a stream, and d is the effective data rate to a dish.Can have different speed if note stream, so above m*r in the formula should replace by following formula: the data transfer rate of all streams simultaneously and maximum.
The result who this technology is used for write data is that data can be read with assigned rate in order to send a lot of streams, and does not need a plurality of copies of the numeral of video image.By the data itemize to a plurality of disk volumes, flow a part reading this document and do not influence for sending another stream and read another part of this document for sending one.I. I.1 dmedia streamer transfer of data and transfer process send the Dynamic Bandwidth Allocation of video to switch 18
Traditional video server generally all meets one of two kinds of forms.They are not (but yet being low bandwidth) video servers with a low price of PC technical construction, use the video server of high bandwidth of supercomputing technical construction (and expensive) exactly.A target of the present invention be the dispensing high bandwidth video, and need not the high price supercomputer technology.
A better method that realizes the high bandwidth low price is to use low switch (circuit switch matrix in length and breadth) 12 handles that postpone based on " node " of a Budget PC video server of interconnected one-tenth (as shown in Figure 1).An importance of dmedia streamer structure is to have used effectively from each storage node 16 and communication nodes 14 available video stream bandwidths.By the special nature of video data (write once, read repeatedly) and switching technique at a low price dynamically, the real-time bandwidth distribution capability combines, thereby makes bandwidth reach maximum.
Figure 18 has shown that the traditional logic between a switch interface and storage node connects.Switch interface must be a full duplex (being that information can send at both direction simultaneously) so that allow video data (and control information) to import into and spread out of storage node.Because video content is write into storage node and is once then read repeatedly, great majority to the storage node bandwidth request towards switch.Under typical switch interface situation, the bandwidth of storage node fails to make full use of, and seldom uses because distribute to that half-band width of write capability.
Figure 19 has shown according to a switch interface of the present invention.This interface its whole bandwidth of dynamic assignment in real time enters or passes in and out switch 18, to satisfy the current needs of node.(storage node 16 is as an example).Communication nodes 14 has similar needs, but their most of bandwidth is in the direction from switch 18.
Dynamic assignment is to come the synthetic logic switch interface 18a of two or more physical switch interface group is realized by the suitable route header of using switch 12.So video data (for example reading for) is assigned to two physical interfaces.This is by realizing the data itemize to a plurality of memory cell as previously mentioned.Receive node the video data combination is reduced to single logic flow.
For example, the speed of switch interface is 2X megabyte/second full duplex in Figure 18, i.e. each direction X megabyte/second.But video data only sends (entering switch from storage node) to a direction usually.Therefore have only the video bandwidth of X megabyte/second to send out, although the ability of node has its twice (2X) from storage node.Storage node does not make full use of.The switch interface of Figure 19 dynamically distributes the bandwidth of this whole 2X megabyte/second so that video is sent to switch from storage node.The result is that the bandwidth of node increases, and the bandwidth of video server is higher, and the expense of each stream is lower.Video data dispensing when J. using the waiting of communication adapter
Digital of digital video data is an order, and continuous, a large amount of, the time is critical, rather than content is critical.Dispensing when video data stream must be with high bit rate etc. need drop to unnecessary spending on the data path minimum.The hardware that receives generally is a video machine top box or some other suitable video data receiver.Standard serial communication protocol is used for synchronously and data verification through being everlasting hardware level adding extra order and data byte in stream.If receiver can not be removed these additional datas pellucidly, just video data stream is destroyed.The additional overhead of being introduced by these and byte has also reduced effective data rate, produces the mistake of video decompression and conversion.
Determined that dispensing in order to guarantee the waiting of user need all be closed most standard serial communication protocol attribute by the video Data Transmission that the standard traffic adapter carries out.The method that reaches this point is difference with the difference of used communication adapter, but its basic thought is described below.Among Figure 20, a serial communication chip 200 in the communication nodes 14 has been forbidden data formatting and integrity information, as parity check, and start and stop bit, cyclic redundancy check (CRC) code and sync byte, and prevented the generation of null character (NUL).Use input FIFO buffering 202,204,206 etc., when allowing the bus cycles loading data block, guarantee the video data stream of one constant (when waiting) output.The fifo buffer 208 of one 1000 byte has been simplified CPU and the bus logic of packing into.
If communication pio chip 200 does not allow producing forbidding of initial synchronisation (sync) byte, the value of sync byte is programmed in the value of first byte of each data block (and the data block pointer is incremented to second byte) so.Byte-aligned also must be managed with real data, thereby any byte of padding (padding byte) all will destroy data flow if not the part of actual compression video data.
In order to reach the required constant high-speed serial data output of high-quality compressed video data, must use a cyclic buffer or a plurality of big buffer (as 202,204,206).This is in the buffer dateout of filling up previously from) to allow time enough to fill an input buffer be essential.Unless buffer packing is that the situation that video finishes can cause a very little buffer to export before the transmission of next buffer is finished, thereby causes the data underrun the finishing in early days of video data flow path.This is with regard to minimum three buffers greatly and independently of needs.Cyclic buffer in the double-mode internal memory (can write when reading) also is a suitable embodiment.The MPEG-1 of 1. compressions of J, 1+, or the video image of MPEG-2 digital data format becomes the television system (NTSC or PAL) of industrial standard with movie conversion.
As previously mentioned, digital of digital video data moves on to the buffer storage from disk.In case enough data have been arranged in the buffer, it is just from internal memory moves on to a interface adapter the communication nodes 14.Used interface is SCSI 20 megabyte/seconds, fast/wide interface, perhaps SSA serial scsi interface.Scsi interface is extended to handles 15 addresses, and maximum 256 of SSA structural support.Other appropriate interface comprises RS422, V.35, V.36 etc., but is not limited to these.
As shown in figure 21, be sent to NTSC adapter 212 (in addition see Figure 20) from a communication nodes 14 by communication bus 210 from the video data of interface, and be cushioned there.Adapter 212 takes out data from a local buffering 214, and there are a plurality of data blocks the there, so that bus performance reaches is the highest.The main target of adapter 212 is to keep data from memory 214 to MPEG chips 216,218, flows when arrive the waiting of NTSC chip 220 and D/A222 then, to guarantee in the dispensing of video and/or audio frequency less than interruption.
MPEG logic module 216,218 converts digital of digital video data (compression) to component-level video and audio frequency.A NTSC encoder 220 becomes the NTSC base-band analog signal to conversion of signals.MPEG audio decoder 216 converts digital audio to parallel digital data, then by a digital to analog converter 222, through filtering, produces about sound and exports.
Producing a purpose of dispensing way to solve the problem to speeds match and when waiting is to obtain such approach, and it not only makes the bandwidth branch of system be delivered to maximum, and has minimum Performance Constraints.
Usually, application developer uses bus structures such as SSA and SCSI to be used for control and dispensing data between processor and mechanical storage equipment, as disk file, and magnetic tape file, optical storage unit etc.Two kinds of buses all comprise makes them be suitable for the attribute of high-bandwidth video data dispensing, as long as the measure of sending when having taked the waiting of control rate and video data.
SCSI bus allows data to burst with 20 megabyte/seconds, and this makes any one vision signal reach the shortest from the time that buffer moves into a specific NTSC adapter.Adapter card 212 comprises a big buffer, and it possesses with peak rate bursts data to memory from bus 210, and removes the performance that data are used to be distributed to NTSC decoding chip 216,218 with much lower speed from buffer 214.Buffer 214 also is divided into a plurality of more minibuffer devices, couples together with software control, as many buffers of endless form connection.
The data block that this permission system dispensing varies in size is to separate buffer, and the order of control broadcast.A benefit of this method be it exempted systems soft ware have any to the request of video data before and with very high branch transmission rate dispensing block of video data.This provides the ability of a lot of video flowings of management under the demand of dynamically handling up for dmedia streamer 10.When the processor in the communication nodes was free, it can produce the dispensing to several big data blocks that will played in order.In a single day this finish, and processor is released controlling other stream, and do not have needs immediately to send slow continuous isochronal data to each port.
For further improving the ratio of performance to price of decoder system, between big decoder buffer 214 and mpeg decoder 216,218, insert a little FIFO memory 224.FIFO memory 224 allows controller 226 little blocks of data, is generally 512 bytes, moves into FIFO 224 from buffer 214, and the latter becomes serial bit stream to data transaction then, is distributed to mpeg decoder 216,218.Audio frequency and video decoding chip 216 and 218 can be obtained input from same serial data stream, decode in the inside separation and to desired data.Data are that mode takes place when waiting from the transmission of the output of FIFO memory 224, perhaps are mode when waiting basically, to guarantee a continual video image is distributed to the user of a user or video image.K. digital video is sent to scsi device
As shown in figure 22, convert scsi command and data flow from the compressed digital video data and the command stream of buffer storage to by device level software, and be sent to a destination adapter 212 with SCSI II high-speed data rate by SCSI bus 210.Data are cushioned then, and supply with the MPEG logic with the content output speed that requires and decompress and be converted to analog video and audio data.In SCSI bus 210, provide feedback with survey data stream and guarantee suitable cache management.
SCSI NTSC/PAL adapter 212 provides a high-level interface with SCSI bus 210, supports subclass of standard SCSI agreement.The normal mode of operation is to open adapter 212, to its write data stream (video and audio frequency), closes adapter 212 when finishing.Adapter 212 fetches data by required speed, to keep buffer full, provides data by communication nodes 14 and storage node 16, and its size is suitably selected to optimize bus transfer and to reduce the bus expense.
If desired, can come the reset system parameter via controlling packet by a model selection scsi command.Video/audio frequency be inner and do not need external control synchronously at adapter 212.Mistake is reduced to minimum, also has synchronous and continuous again automatically audio/video output.K 1.SCSI level command description
Directly access means and sequential access devices order can mix the function of using with adjusting SCSI video o adapter with the standard normal commands.To all scsi commands, after each order, all return an effective state byte, if return an inspection condition, (Sense data area) loading error situation then in the sense data district.Used standard scsi command comprises RESET (resetting), INQUIRY (inquiry), REQUESTSENSE (request is read), MODE SELECT (model selection), MODESENSE (pattern is read), READ (reading), WRITE (writing), RESERVE (reservation), RELEASE (release), TEST UNITREADY (test cell preparation).Video commands
The video control command is the video output control command of user class, is the expansion of the standard commands listed above.They provide the user class front end of a simplification, these low-level operation systems or scsi command and SCSI video o adapter 212 direct interfaces to low-level operation system or scsi command.The realization of each order utilize microcode to come the essential video equipment function of emulation and video and the audio frequency avoiding causing by invalid state of a control unusual.Scsi command-SCSI begins/stop element order-be used to a video control command to translate target SCSI video o adapter 212, and have necessary parameter and move with order.This has simplified user's application interface and adapter card 212 microcodes.Following order is utilized: stop (SCSI begins/stop 1-parameter=pattern)
The data that are input to MPEG chipset (216,218) are ended, the sound noise reduction, and video becomes blank.Parameter field is selected stop mode.Normal mode is to allow buffer and position indicator pointer keep the present situation, and play command continues in the same position of video flowing like this.Second pattern (film finishes or ends) is the beginning of buffer pointer being put next buffer, and anterior bumper is worked as in release.The 3rd pattern also finishes situation to film, is delayed to data buffer change sky but stop (noiseless nothing image).The 4th pattern can be used for the realization of certain mpeg decoder, for a delay stop to provide sound, but when data use up, fix last valid frame.In each case, the microcode of video adapter 212 is determined halt, so that the output of video and video stops on correct border, restarts neatly allowing.Suspend (SCSI START/STOP 2-printenv)
The data that are input to MPEG chipset (216,218) are ended, and sound is eliminated the noise, but video does not become blank.This makes MPEG video chip collection (216,218) keep the anchor-frame of last good frame.This is subject to avoids the aging of video tube.Preferably cease and desist order by 18 one of the issue of control node, if but not receiving orders in 5 minutes, video output can become blank automatically.The microcode of adapter 212 keeps the decoder states of buffer positions, to allow to go back to smoothly broadcast.There is not figure-noiseless (SCSI START/STOP 3-parameter=pattern)
This order can make video output become empty and not influence audio frequency output, makes audio frequency become mute and does not influence video, and is perhaps not only noiseless but also do not have a figure.Noiseless and nothing image can be closed with an order that has mode parameter, and its makes that conversion is more level and smooth and reduces and order expense.These are being realized after decompression and conversion on video adapter 212, and hardware controls are being arranged to guarantee the level and smooth conversion of forward.Slow play (SCSI START/STOP 4-parameter=speed)
This order is reduced to the input rate of MPEG chipset (216,218), makes its anchor-frame off and on, the slow play function of simulation VCR.It is mute to avoid the numeric error noise that sound becomes.Parameter field is specified one from 0 to 100 relative velocity.The fault processing of decoding chip collection (216,218) is forbidden in a kind of substituting realization, revises the broadcasting speed of the concentrated data clock speed of decoding chip to expectation then.This depends on the flexibility of the timing topology of video adapter.Play by (SCSI START/STOP 5-parameter=buffer)
This order beginning provides process to the data of MPEG chipset (216,218), starts the output of video and audio frequency.Transmit buffer and select number determining which buffer beginning played in order, and current play-out buffer (typical case) is used in one 0 value indication from.Non-0 value only just is accepted when adapter 212 is in stop mode (STOPPED mode), if at park mode (PAUSED mode), buffer selects parameter to be left in the basket, and selects number and the position recovers to play and use when anterior bumper.
When " broadcast ", controller 226 order land wheel between each buffer changes to keep a stable data to flow to into MPEG chipset (216,218).Data are read in the MPEG bus with suitable speed from buffer, and 0 beginning is up to having read N byte from the address, and controller 226 switches to next buffer and continues read data then.The SCSI rapid data transmission that adapter bus and microcode provide enough bandwidth to be used for adapter buffering 214, the output FIFO 224 of data to supply mpeg decompression shrinking chip (216,218) also is used for stably packing into.F.F. (SCSI START/STOP 6-parameter=speed)
This order is used for the F.F. mode scan-data of imitation VCR.There are two kinds of operator schemes to determine by rate parameter.Speed is that 0 meaning is F.F. promptly, and video and audio frequency should be become blank and become mute, and buffer is refreshed, and carries out an implicit play command when a reposition forward from video flowing is received data.The speed of the integer indication inlet flow F.F. of 1-10.Video is by skipping data block by " sampling ", to obtain the average data rate of appointment.Adapter 212 is skipped to play a part of data near normal speed, plays next part then, with simulation F.F. action.Unroll (SCSI START/STOP 7-parameter=speed)
This order is used for the mode of the unrolling scan-data backward of simulation VCR.The operation of two kinds of patterns is arranged, determine by rate parameter.Speed is that 0 meaning is a fast rewind, and video and audio frequency should become blank and become mute, and buffer is refreshed, when a reposition forward from video flowing is received data, and play command of implicit execution.The speed that the integer indication inlet flow of 1-10 unrolls.Video is by skipping data block by " sampling ", to obtain the average data rate of appointment.The data flow of unrolling be by from previous video flowing position " sampling " to little blocks of data assemble up and set up.Adapter card 212 is handled these conversions and smoothly synchronously so that play with normal speed, jumps back to next sampling section with the simulation scanning of unrolling.K 2. buffer managements
Digital video frequency server provides data to a lot of concurrent output equipments, but digital of digital video data decompresses and conversion needs a constant data flow.Data buffering is used to utilize the data burst mode transfer of SCSI, still avoids underload gentle the breaking through of data to carry simultaneously, allows the minimum intervention of dmedia streamer 10 usefulness to transmit data to a lot of streams.SCSI video adapter card (Figure 21,22) comprises a big buffer 214 and is used for video data, so that make full use of SCSI burst mode data transfer process.An illustrative configuration can be the buffer 214 of 768 K, is managed as the circulating type cyclic buffer by local logic.Cyclic buffer should dynamically be handled different data block sizes, rather than regular length buffering, the latter during for transmission digital video data storage and administration overhead all be poor efficiency.
The microcode of video adapter card 212 is supported a plurality of buffer pointers, preserves a data top and current length and data top.This allows to rewrite once more kaput transmission, perhaps allows a pointer be positioned on the interior byte location of current buffer if necessary.The length of data block accurately keeps (even for example intermediate logic is used the long word alignment, also at byte or word) to guarantee the active data dispensing of decoding chip collection (216,218) by the length of transmission.This method drops to the steady state operation expense minimum, also allows the flexible control to the data buffering simultaneously.K 2.1 buffers are selected and the location
Need to suppose a plurality of set of buffer, then use a plurality of pointers for the operation of all relevant buffers.For example, a set may be used for selecting the current location of play-out buffer and this buffer, and second set selected write buffer and the interior position (being generally 0) of this buffer to be used for data and be pre-loaded into operation.Each data block of receiving is kept a current length and maximum length value, because also support elongated data block.K 2.2 automatic modes
Buffer operation is by controller 226 management of video adapter, the N byte data be placed on next ready buffering empty same in, from the address 0 of this buffer.Whether controller 226 follows the tracks of the length of data in each buffer and this data " broadcast ".Whenever enough free buffer space have been arranged, the data that this card is just accepted next write order and DMA enter this buffer.If do not have enough free buffer space accepting whole data block (generally being slow play or pause conditions), just do not accept write order and return the return code of a buffer full.K 2.3 manual modes
A positioning command is used for to the position (being generally 0) in " current " write buffer of each buffer access order (write, wipe etc.) selection and this buffer.For a successful last data block of transmitting, this buffer positions is the starting point for data.This preferably does for the video flowing transfer management, and activates automatic mode as soon as possible again, with the order expense in the minimizing system as far as possible.K 2.4 error managements
The error management of digital of digital video data transmission requires and uses SCSI different in the random data visit of data handling utility usually.Slight loss of data is interrupted seriously not as transmission, and therefore traditional retry and data validity strategy are modified or have forbidden.Common SCSI mistake processing procedure is after the state phase when finishing each order is returned a state byte.State byte or point out (OO) situation of a GOOD (well), a BUSY (hurrying) situation (8h) if-target SCSI chip 227 can not take orders, or a CHECK CONDITION (inspection) is if (02h) mistake of situation-take place.K 2.5 wrong recoveries
The controller 226 of SCSI video adapter 212 produces a request sense command automatically when obtaining the response of a CHECKCONDITION, come loading error and state information, and determine whether to carry out a recovery process.Common recovery process is the state of weeding out errors, and abandons ruined data, and recovers normal play as early as possible.Under worst case, adapter 212 may be had to reset, the data of resetting before recovering broadcast.Error condition is with next INQUIRY (inquiry) or REQUEST SENSE SCSI (SCSI is read in request) operation note and report host system.K 2.6 automatic retries
To the situation of buffer full or device busy, retry carries out maximum X time automatically, and wherein X depends on the flow data rate.This just just is allowed to when next data buffering arrives.At that constantly, if situation (is buffer full, unloads not to be in and suspend or slow mode playback) just write down a mistake, to have necessity and carry out device reset or removing unexpectedly, to recover and the continuation video playback.
Though mainly be to be described to user's situation to sending a video image, but will be appreciated that and to use the two-way video adapter to receive a video image, video image is digitized as a numeral, and this numeral is transferred to communication nodes 14 along bus 210, it is stored in by in the storage node 16,17 of controlling node 18 appointments by the low switch 12 that postpones.
The description that is understood that the front is just described illustrative of the present invention.The personage who is proficient in the knowledge of can design multiple substituting and modification in the case of without departing from the present invention.Therefore, the invention is intended to contain all these and substitute, modifications and variations, they are all in the scope of appending claims.